{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "csye6225 ci/cd formation template",
 
  "Parameters": {
    "bucketName": {
        "Description": "Bucket name",
        "Type": "String"
      }
  },

  "Resources" : {
    "EC2Role": {
        "Type": "AWS::IAM::Role",
        "Properties": {
           "AssumeRolePolicyDocument": {
              "Version" : "2012-10-17",
              "Statement": [ {
                 "Effect": "Allow",
                 "Principal": {
                    "Service": [ "ec2.amazonaws.com" ]
                 },
                 "Action": [ "sts:AssumeRole" ]
              } ]
           },
           "Path": "/",
           "RoleName" : "CodeDeployEC2ServiceRole"
      }
     },
 
     "CodeDeployRole": {
        "Type": "AWS::IAM::Role",
        "Properties": {
           "AssumeRolePolicyDocument": {
              "Version" : "2012-10-17",
              "Statement": [ {
                 "Effect": "Allow",
                 "Principal": {
                    "Service": [ "codedeploy.amazonaws.com" ]
                 },
                 "Action": [ "sts:AssumeRole" ]
              } ]
           },
           "ManagedPolicyArns" : ["arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole"], 
           "Path": "/",
           "RoleName" : "CodeDeployServiceRole"
      }
     },
     
     "CodeDeployEC2S3" : {
     "Type" : "AWS::IAM::ManagedPolicy",
     "Properties" : {
      "ManagedPolicyName" : "CodeDeploy-EC2-S3",
     "Description" : "Policy for creating a test database",
     "Roles" : ["CodeDeployEC2ServiceRole"],
     "Path" : "/",
     "PolicyDocument" :   {
     "Version":"2012-10-17", 
     "Statement" : [{
       "Effect" : "Allow",           
       "Action" :  ["s3:Get*","s3:List*"],
       "Resource" : "*" 
     }]
   }
 }
    },
     "TravisUploadToS3" : {
     "Type" : "AWS::IAM::ManagedPolicy",
     "Properties" : {
     "ManagedPolicyName" : "Travis-Upload-To-S3",
     "Users": ["TravisCI"],
     "Description" : "Policy for creating a test database",
     "Path" : "/",
     "PolicyDocument" :   {
     "Version":"2012-10-17", 
     "Statement" : [{
       "Effect" : "Allow",           
       "Action" :  ["s3:PutObject"],
       "Resource" : "*"
     }]
   }
 }
    },

    "TravisCodeDeploy" : {
     "Type" : "AWS::IAM::ManagedPolicy",
     "Properties" : {
     "ManagedPolicyName" : "Travis-Code-Deploy",
     "Users": ["TravisCI"],
     "Description" : "Policy for creating a test database",
     "Path" : "/",
     "PolicyDocument" :   {
     "Version":"2012-10-17", 
     "Statement" : [  {
     "Effect": "Allow",
     "Action": [
       "codedeploy:RegisterApplicationRevision",
       "codedeploy:GetApplicationRevision"
     ],
     "Resource": [
       "*"
     ]
   },
   {
     "Effect": "Allow",
     "Action": [
       "codedeploy:CreateDeployment",
       "codedeploy:GetDeployment"
     ],
     "Resource": [
       "*"
     ]
   },
   {
     "Effect": "Allow",
     "Action": [
       "codedeploy:GetDeploymentConfig"
     ],
     "Resource": [
       "*"
     ]
   }]
   }
 }
    },

  "myS3Bucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": { "Ref": "bucketName" }
      }
    },
    "CodeDeployApplication": {
    "Type": "AWS::CodeDeploy::Application",
    "Properties": {
      "ApplicationName": "csyecodedeploy"
    }
  },
        "Deploymentgroup" :{
          "Type" : "AWS::CodeDeploy::DeploymentGroup",
          "Properties" : { 
              
            "ApplicationName" : "csyecodedeploy",
            "DeploymentGroupName" : "csyecodedeploy",
            "ServiceRoleArn" : "arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole"
          }
        }
  }

}

