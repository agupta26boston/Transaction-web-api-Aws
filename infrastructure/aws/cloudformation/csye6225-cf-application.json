{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "csye6225 application formation template",

   "Parameters": {
  "DBName": {
    "Description": "Database Name",
    "Type": "String"
  },
  "DBUser": {
    "Description": "Database User",
    "Type": "String"
  },
  "DBPassword": {
    "Description": "Database Password",
    "Type": "String"
  },
  "bucketName": {
    "Description": "Bucket name",
    "Type": "String"
  },
  "DBEngine": {
    "Description": "DB Engine",
    "Type": "String"
  },
  "DBAllocatedStorage": {
    "Description": "DB AllocatedStorage",
    "Type": "String"
  },
  "DBEngineVersion": {
    "Description": "DB EngineVersion",
    "Type": "String"
  },
  "DBInstanceClass": {
    "Description": "DB InstanceClass",
    "Type": "String"
  },
  "DBInstanceIdentifier": {
    "Description": "DBInstanceIdentifier",
    "Type": "String"
  },
  "EC2ImageId":{
      "Description": "EC2 ImageId",
      "Type": "String"
    },
    "EC2InstanceType":{
      "Description": "EC2 InstanceType",
      "Type": "String"
    },
    "EbsDeviceName" : {
      "Description": "Ebs DeviceName",
      "Type": "String"
    },
    "EbsVolumeType" : {
      "Description": "Ebs VolumeType",
      "Type": "String"
    },
    "EbsVolumeSize" : {
      "Description": "Ebs VolumeSize",
      "Type": "Number"
    },
    "KeyPairName" : {
      "Description": "Key Pair Name",
      "Type": "String"
    },
    "MySqlClientPass":{
    "Description": "Root password for MySQL client on EC2 Instance",
    "Type": "String"
  }
  },
   "Resources" : {

    "NVNDynamoDBTable": {
          "Type": "AWS::DynamoDB::Table",
          "Properties": {
      "AttributeDefinitions": [
        {
          "AttributeName": "Id",
          "AttributeType": "S"
        }
      ],
      "KeySchema": [
        {
          "AttributeName": "Id",
          "KeyType": "HASH"
        }
      ],
      "ProvisionedThroughput": {
        "ReadCapacityUnits": "5",
        "WriteCapacityUnits": "5"
      },
      "TimeToLiveSpecification": {
        "AttributeName": "TimeToLive",
        "Enabled": "TRUE"
      },
      "TableName": "csye6225"
          }
    },

    "NVNCloudS3Bucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": { "Ref": "bucketName" },
        "AccessControl": "Private"
      }
    },
    


    "NVNCloudRDSDB": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "Engine": { "Ref": "DBEngine"},
        "AllocatedStorage": { "Ref": "DBAllocatedStorage"},
        "EngineVersion": { "Ref": "DBEngineVersion"},
        "DBInstanceClass": { "Ref": "DBInstanceClass"},
        "MultiAZ": "false",
        "DBInstanceIdentifier": { "Ref": "DBInstanceIdentifier"},
        "MasterUsername": { "Ref": "DBUser" },
        "MasterUserPassword": { "Ref": "DBPassword" },
        "PubliclyAccessible": "false",
        "DBName": { "Ref": "DBName" },
        "VPCSecurityGroups": [{ "Fn::ImportValue" : "RDSGroupName" }],
        "DBSubnetGroupName": { "Fn::ImportValue" : "DBSubnetGroupName" }
      },
      "DeletionPolicy": "Delete"
    },


    "EC2Instance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "ImageId": { "Ref": "EC2ImageId" },
        "KeyName" : { "Ref": "KeyPairName" },
        "IamInstanceProfile" :{"Fn::ImportValue" : "EC2InstanceProfile"},
        "InstanceType": { "Ref": "EC2InstanceType" },
           "SubnetId" : { "Fn::ImportValue": "PublicSubnet1"},
           "SecurityGroupIds" : [{"Fn::ImportValue" : {"Fn::Sub" : "EC2GroupName"}}],
           "Tags":[{
            "Key": "Name",
            "Value": "CloudEC2"
            }],
           "BlockDeviceMappings": [
                {
                    "DeviceName" : { "Ref": "EbsDeviceName"},
                    "Ebs" : {
                        "VolumeType" : { "Ref": "EbsVolumeType"},
                        "VolumeSize" :{ "Ref": "EbsVolumeSize"},
                        "DeleteOnTermination" : true
                    }
                }
            ],
            "UserData": {
              "Fn::Base64": {
                  "Fn::Join": [
                      "\n",
                      [
                          "#!/bin/bash -xe ",
                          "yum install python ruby ntp wget java-1.8.0-openjdk-devel -y",
                          "wget https://aws-codedeploy-us-east-1.s3.amazonaws.com/latest/install \n",
                          "chmod +x ./install \n",
                          "./install auto \n",
                          "service codedeploy-agent start \n",                                                                                                                              
                          "systemctl start ntpd",
                          "systemctl enable ntpd",
                          "groupadd tomcat",
                          "useradd -M -s /bin/nologin -g tomcat -d /opt/tomcat tomcat",
                          "cd /tmp",
                          "wget http://apache.mirrors.pair.com/tomcat/tomcat-8/v8.5.34/bin/apache-tomcat-8.5.34.tar.gz",
                          "#mkdir /opt/tomcat",
                          "tar xvf apache-tomcat-8*tar.gz -C /opt/tomcat --strip-components=1",
                          "cd /opt/tomcat",
                          "chgrp -R tomcat /opt/tomcat",
                          "chmod -R g+r conf",
                          "chmod g+x conf",
                          "chown -R tomcat webapps/ work/ temp/ logs/",
                          "cd /usr/lib/systemd/system",
                          "touch tomcat.service",
                          "echo '[Unit]' > tomcat.service",
                          "echo 'Description=Apache Tomcat Web Application Container' >> tomcat.service",
                          "echo 'After=syslog.target network.target' >> tomcat.service",
                          "echo '[Service]' >> tomcat.service",
                          "echo 'Type=forking' >> tomcat.service",
                          "echo 'Environment=JAVA_HOME=/usr/lib/jvm/jre' >> tomcat.service",
                          "echo 'Environment=CATALINA_PID=/opt/tomcat/temp/tomcat.pid' >> tomcat.service",
                          "echo 'Environment=CATALINA_HOME=/opt/tomcat' >> tomcat.service",
                          "echo 'Environment=CATALINA_BASE=/opt/tomcat' >> tomcat.service",
                          "echo 'Environment=\"CATALINA_OPTS=-Xms512M -Xmx1024M -server -XX:+UseParallelGC\"' >> tomcat.service",
                          "echo 'Environment=\"JAVA_OPTS=-Djava.awt.headless=true -Djava.security.egd=file:/dev/./urandom\"' >> tomcat.service",
                          "echo 'ExecStart=/opt/tomcat/bin/startup.sh' >> tomcat.service",
                          "echo 'ExecStop=/bin/kill -15 $MAINPID' >> tomcat.service",
                          "echo 'User=tomcat' >> tomcat.service",
                          "echo 'Group=tomcat' >> tomcat.service",
                          "echo 'UMask=0007' >> tomcat.service",
                          "echo 'RestartSec=10' >> tomcat.service",
                          "echo 'Restart=always' >> tomcat.service",
                          "echo '[Install]' >> tomcat.service",
                          "echo 'WantedBy=multi-user.target' >> tomcat.service",
                          "systemctl daemon-reload",
                          "#systemctl start cloudwatch.service",
                          "#systemctl enable cloudwatch.service",
                          "systemctl enable tomcat.service",
                          "systemctl start tomcat.service",

                          "sudo touch /opt/cloudwatch-config.json",
                          "cd ../../../../..",
                          "cd /opt",
                          "#sudo echo '{' > cloudwatch-config.json",
                          "sudo echo '{\"agent\":{' >> cloudwatch-config.json",
                          "sudo echo '\"metrics_collection_interval\":10,' >> cloudwatch-config.json",
                          "sudo echo '\"logfile\": \"/var/logs/amazon-cloudwatch-agent.log\"' >> cloudwatch-config.json",
                          "sudo echo '},' >> cloudwatch-config.json",
                          "sudo echo '\"logs\": {\"logs_collected\": {\"files\": {\"collect_list\": [{\"file_path\": \"/opt/tomcat/logs/catalina.out\",\"log_group_name\": \"csye6225_fall2018\",\"log_stream_name\": \"webapp\"}]}},\"log_stream_name\": \"cloudwatch_log_stream\"}}' >> cloudwatch-config.json",
                          "cd ..",
                          "sudo wget https://s3.amazonaws.com/amazoncloudwatch-agent/centos/amd64/latest/amazon-cloudwatch-agent.rpm",
                          "sudo rpm -U ./amazon-cloudwatch-agent.rpm",
                          "sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:/opt/cloudwatch-config.json -s",     
                          "cd ../../../../..",
                          "sudo wget https://s3.amazonaws.com/configfileforcloudwatch/amazon-cloudwatch-agent.service",
                          "sudo cp amazon-cloudwatch-agent.service /usr/lib/systemd/system/",
                          "sudo systemctl enable amazon-cloudwatch-agent.service",
                          "sudo systemctl start amazon-cloudwatch-agent.service",   
                          "sudo cd /etc/systemd/system \n",
                          {
                            "Fn::Join": [
                                "",
                                ["sudo bash -c 'cat <<EOT > awslogs.service \n",
                                  "[Unit] \n",
                                  "Description=Service for CloudWatch Logs agent \n",
                                  "After=rc-local.service \n",

                                  "[Service] \n",
                                  "Type=simple \n",
                                  "Restart=always \n",
                                  "KillMode=process \n",
                                  "TimeoutSec=infinity \n",
                                  "PIDFile=/var/awslogs/state/awslogs.pid \n",
                                  "ExecStart=/var/awslogs/bin/awslogs-agent-launcher.sh --start --background --pidfile $PIDFILE --user awslogs --chuid awslogs &amp; \n",
                                  "[Install] \n",
                                  "WantedBy=multi-user.target \n",
                                  "EOT' \n"
                                ]
                              ]
                            },
                          "sudo systemctl start awslogs.service \n",
                          "sudo systemctl stop awslogs.service \n",
                          "sudo systemctl restart awslogs.service \n",
                          "sudo systemctl enable awslogs.service \n",

                          "cd /opt/tomcat",
                          "sudo touch bin/setenv.sh",
                          "sudo chmod 777 bin/setenv.sh",
                          { "Fn::Join":["",["sudo echo 'export USERNAME=",{"Ref" : "DBUser"}, "'>> bin/setenv.sh"]]},
                          { "Fn::Join":["",["sudo echo 'export PASSWORD=",{"Ref" : "DBPassword"}, "'>> bin/setenv.sh"]]},       
                          "sudo echo 'export DIALECT=org.hibernate.dialect.MySQL5Dialect' >> bin/setenv.sh",
                          "sudo echo 'export DRIVER=com.mysql.jdbc.Driver' >> bin/setenv.sh",
                          "sudo echo 'export SPRING_PROFILES_ACTIVE=aws' >> bin/setenv.sh",


                          {
                            "Fn::Join": [
                              "",
                              [
                                "sudo echo 'export URL=jdbc:mysql://",
                                {
                                  "Fn::GetAtt": [
                                    "NVNCloudRDSDB",
                                    "Endpoint.Address"
                                  ]
                                },

                                ":3306/",{"Ref" : "DBName"},"' >> bin/setenv.sh"

                              ]
                            ]
                          },
                          {
                            "Fn::Join": [
                              "",
                              [
                                "sudo echo 'export BUCKETNAME=",
                                {"Ref" : "bucketName"},
                                "' >> bin/setenv.sh"
                              ]
                            ]
                          },


                          "systemctl start tomcat.service"


                      ]
                  ]
              }
            }
          }
          }      
  },
  "Outputs": {
    "WebAppS3BucketName": {
      "Description": "Web Application S3 Bucket Name",
      "Value": { "Ref": "NVNCloudS3Bucket"},
      "Export" : { "Name" : "WebAppS3BucketName" }
    },
    "EC2Instance": {
      "Description": "EC2 Instance",
      "Value": { "Ref": "EC2Instance"},
      "Export" : { "Name" : "EC2Instance" }
    }
  }

}